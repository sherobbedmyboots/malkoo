# Investigating Malware on Macs

The detection of potentially malicious traffic coming from one of our systems requires further investigation to confirm the presence of malware.  When this happens, we need to be able to associate the traffic in question to a process on the host. 
Investigating the process and the nature of the traffic being
sent and received will help to determine if the host is in fact infected. 
Once it is confirmed as malware, we also need to be able to explain the
chain of events that led to the infection.

In this exercise, beaconing activity was observed originating from a Mac system (\<host\>).  They report that the system
is sending HTTP GET and POST requests every minute to the IP address
\<ip\> using the following webpages:

`/login/process.jsp`
`/admin/get.php`
`/news.asp`

A packet capture containing traffic of the initial infection was
provided:

	pcap-3.pcap 

Find the process that is the source of the traffic.


### Commands that will help you identify the malware:

- Check a specific user's running processes by typing `ps -fc -u <user>`

- Check hosts on the network contacted in last 20 minutes by typing `arp -an`

- Monitor live TCP network activity by typing `nettop -m tcp`

- Show information about a specific process by typing `ps -f -p <pid>`

- Show open files being used by this process by typing `lsof -p <pid>`

### Commands that will help you identify the user's actions:

- Check files in the user's Downloads folder by typing `ls -lAh /Users/<user>/Downloads`

- Review the user's command history by typing `cat /Users/<user>/.bash_history`

- Review the user's bash sessions by typing `cat /Users/<user>/.bash_sessions/\`*

- Search authd logs for user activity by typing `for i in $(ls -tr /var/log/authd.*);do zgrep <user> $i;done`

- Show last logins of the system by user by typing `last`

### Wireshark filters that will help you identify the C2:

- Show all HTTP requests from the victim by using the filter `ip.src == <ip> && http.request`

- Show all DNS queries from the victim by using the filter `ip.src == <ip> && dns.qry.type == A`

- Show all HTTP objects by going to File --> Export Objects --> HTTP

- Review all traffic between the attacker and victim by using the filter `ip.addr == <ip> && ip.addr == <ip>`

- Review interesting conversations with Right Click --> Follow TCP Stream

### Answer the following questions:

1. What process is the malware running under?

2. What site did the user get the malware from?

3. How did the user end up on that site?

4. How was the malware able to start and run on the system?

5. What evasion techniques did the malware use?

Keep in mind, client side attacks require the user to perform an action
such as click a link, open an email, run an attachment, open a document,
etc.  You'll need to use the packet capture, event logs, and OS commands
to gather all the information necessary for building a complete timeline
of events.
