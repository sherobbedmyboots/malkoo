#  Analyzing Domain Fronting Malware

In this example, a user was socially engineered to open a malicious
Excel document and enable the macros to view the content.  After
inspecting traffic to and from the victim host that day, only traffic to
legitimate websites was observed.  The malware contained in the document
is suspected of using domain fronting in order to mask the true
destination of its C2 server.  Using the document and the packet capture
of the traffic, determine the website the malware is using to
communicate to its C2 server and as much information as possible about
the actual C2 server. 

The two artifacts are located on the OOB at:

    /CSIRT/Sample-Files/CSIRT-pcap-6.pcapng

    /CSIRT/Sample-Files/Cheat_Codes_List.xls

### Domain Fronting

Domain fronting is the use of high-reputation domains, such as Content
Delivery Networks (CDN), to forward and hide the true destinations of
traffic.  Front end servers of CDNs such as Amazon CloudFront, Google,
Microsoft Azure, CloudFlare, Fastly, and Akamai can be used to "route"
traffic to another host on their infrastructure without revealing the
identity of the destination host.  This destination host could be a
proxy, mirror, Tor bridge, file server---anything, and could allow an
insider or malware to communicate to an unidentifiable host (via an
encrypted channel when HTTPS is used).

Normal behavior for CDNs:

- A request for an infrastructure resource is sent to the CDN

- The CDN looks for the Host header to identify what resource the
    client is requesting

- The traffic is forwarded to the requested resource

- The response is returned to the client

Here is an example of this using HTTP:

My workstation (A) sent a GET request to ssl.gstatic.com (B) with a host
header set to news.google.com (C).  The web page that was returned is
from Google News (C):

```powershell
irm -proxy <proxy> -uri http://ssl.gstatic.com -headers @{Host='news.google.com'} -useragent <UA> | sls '<title>.*</title>' | %{$_.Matches} | %{$_.Value}
```

![](images/Analyzing%20Domain%20Fronting%20Malware/image001.jpg)

Let's look how this is logged in our environment:

| | |
|-|-|
|Hostname B is queried|logged by Infoblox|
|Hostname B is in the URI|logged by BCP|
|Hostname C is in the Host|header logged by BCP|

In this case, the Blue Coats can see that the host header is different
and log this single web request as two separate connections.  Notice the
ones to Google News use the CONNECT method, are logged with a later
timestamp, and have much larger bytes transferred (the web page
content):

![](images/Analyzing%20Domain%20Fronting%20Malware/image002.png)


For HTTPS:

When using HTTPS, the TLS handshake happens before the CDN front end
server sees any HTTP headers.  After the TLS negotiation, the connection
is encrypted and the client sends its HTTP request with a host header
containing the actual destination.

HTTPS traffic:

| | |
|-|-|
|Hostname B is queried|logged by Infoblox|
|Hostname B is in the Client Hello as the SNI|logged by BCP|
|**Hostname C** is in the Host header|***\* Traffic is encrypted at this point\****|


As before, when the CDN front end server receives the traffic, it
forwards it on to the hostname in the Host header, Hostname C.  And the
content returned to the client is actually from Hostname C, which was
not seen in the network traffic or logged by any tools.

Here are some common services that can be used for domain fronting:

| | |
| -|-|
|Google App Engine|gstatic.com, google.com, gmail.com, googleapis.com, etc.|
|Amazon CloudFront|amazon.com, awsstatic.com|
|Microsoft Azure|vomsecn.net, aspnetcdn.com|
|Fastly|fastly.com|
|CloudFlare|cloudflare.com|
|Akamai|akamai.net|

Here is a good write up on malware that combined domain fronting with
Tor: 
<https://www.fireeye.com/blog/threat-research/2017/03/apt29_domain_frontin.html>


### Analysis of the Excel Document

- Open the macro and inspect the code used to infect the system

- Execute the macro to see how it affects the system

- Use Process Monitor to see what network connections, processes,
    registry keys, files change when it's executed

- Use FakeDNS to resolve any addresses that won't resolve

- Use PowerShell commands, logs, etc. to obtain details about the
    malicious files/processes created

### Analysis of the Network Traffic

- Use filters to summarize the user's activity, sites visited, type of
    traffic, etc.

- Use filters to compare destinations by bytes/packets exchanged

- Use filters to inspect suspicious traffic, downloads, beaconing

- Use NetworkMiner, Tcpdump, and Wireshark to identify anomalies

### Questions

1. From which website did the user most likely get the file?

2. Which CDN is the malware using to communicate to its C2 server?

3. What information are you able to determine about the malware's C2
    server?

4. How does the malicious macro infect the Windows system?

5. What indicators could we use to look for other systems infected with
    this malware?
